{% extends "admin/base.html" %}
{% load static %}
{% block title %}Curexa Admin — Medicine Inventory {% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/medication_list.css' %}" />
{% endblock %}

{% block page_header %}
<!-- Breadcrumb above title -->
<div class="breadcrumb-above-title">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-0">
      <li class="breadcrumb-item">
        <a href="{% url 'admin_dashboard' %}">Dashboard</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">Medicine</li>
    </ol>
  </nav>
</div>
  <!-- Page Header -->
  <div class="page-title-section">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="page-title"><i class="fas fa-pills me-2"></i>Medicine Inventory</h1>
        <p class="page-subtitle">Manage and monitor all pharmaceutical products in your inventory</p>
      </div>
      <div class="d-none d-md-block">
        <a href="{% url 'medicine_add' %}" class="btn btn-medical-primary">
          <i class="fas fa-plus-circle me-2"></i> Add New Medicine
        </a>
      </div>
    </div>
  </div>
{% endblock %}

{% block content %}
  <!-- Filters and Search -->
  <div class="row mb-4">
    <div class="col-md-4 mb-3">
      <div class="medical-input-group">
        <span class="input-group-text"><i class="fas fa-search"></i></span>
        <input type="text" id="search" class="form-control" placeholder="Search by name, SKU or brand...">
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="medical-input-group">
        <span class="input-group-text"><i class="fas fa-filter"></i></span>
        <select id="filterCategory" class="form-select">
          <option value="all">All Categories</option>
          <option value="medicine">Medicine</option>
          <option value="supplement">Supplement</option>
          <option value="equipment">Medical Equipment</option>
          <option value="personal-care">Personal Care</option>
        </select>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="medical-input-group">
        <span class="input-group-text"><i class="fas fa-sort"></i></span>
        <select id="sortBy" class="form-select">
          <option value="name-asc">Name (A → Z)</option>
          <option value="name-desc">Name (Z → A)</option>
          <option value="price-asc">Price (Low → High)</option>
          <option value="price-desc">Price (High → Low)</option>
          <option value="stock-desc">Stock (High → Low)</option>
          <option value="stock-asc">Stock (Low → High)</option>
        </select>
      </div>
    </div>
    <div class="col-md-2 mb-3 d-flex">
      <button id="exportCsv" class="btn medical-btn-outline flex-fill">
        <i class="fas fa-download me-2"></i> Export CSV
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card stats-card total h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title text-muted mb-2">Total Products</h6>
              <h2 id="statTotal" class="card-text fw-bold mb-0">0</h2>
            </div>
            <i class="fas fa-boxes fs-1" style="color: var(--medical-blue); opacity: 0.7;"></i>
          </div>
          <div class="mt-3">
            <small class="text-muted"><i class="fas fa-info-circle me-1"></i> All inventory items</small>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card stats-card low h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title text-muted mb-2">Low Stock</h6>
              <h2 id="statLow" class="card-text fw-bold mb-0">0</h2>
            </div>
            <i class="fas fa-exclamation-triangle fs-1" style="color: var(--medical-warning); opacity: 0.7;"></i>
          </div>
          <div class="mt-3">
            <small class="text-muted"><i class="fas fa-info-circle me-1"></i> Stock &lt; 10 units</small>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card stats-card active h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title text-muted mb-2">Active</h6>
              <h2 id="statActive" class="card-text fw-bold mb-0">0</h2>
            </div>
            <i class="fas fa-check-circle fs-1" style="color: var(--medical-green); opacity: 0.7;"></i>
          </div>
          <div class="mt-3">
            <small class="text-muted"><i class="fas fa-info-circle me-1"></i> Available for sale</small>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card stats-card disabled h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title text-muted mb-2">Disabled</h6>
              <h2 id="statDisabled" class="card-text fw-bold mb-0">0</h2>
            </div>
            <i class="fas fa-ban fs-1" style="color: var(--medical-alert); opacity: 0.7;"></i>
          </div>
          <div class="mt-3">
            <small class="text-muted"><i class="fas fa-info-circle me-1"></i> Temporarily unavailable</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Medicine Grid -->
  <div class="row" id="medicineGrid"></div>

  <!-- Empty State -->
  <div id="emptyState" class="empty-state d-none">
    <div class="empty-state-icon">
      <i class="fas fa-pills"></i>
    </div>
    <h4 class="text-muted mb-3">No medicines found</h4>
    <p class="text-muted mb-4">Try adjusting your search or filter criteria</p>
    <button class="btn btn-medical-primary" onclick="clearFilters()">
      <i class="fas fa-redo me-2"></i> Clear All Filters
    </button>
  </div>

  <!-- Pagination -->
  <div class="d-flex justify-content-between align-items-center mt-4">
    <div id="pageInfo" class="page-info">Page 1 of 1</div>
    <div class="medical-pagination">
      <button id="prevPage" class="btn btn-outline-primary btn-sm me-2">
        <i class="fas fa-chevron-left me-1"></i> Previous
      </button>
      <button id="nextPage" class="btn btn-outline-primary btn-sm">
        Next <i class="fas fa-chevron-right ms-1"></i>
      </button>
    </div>
  </div>
</div>

<!-- Floating Add Button -->
<a href="{% url 'medicine_add' %}" class="floating-add-btn">
  <i class="fas fa-plus"></i>
</a>

<script>
const els = {
  grid: document.getElementById('medicineGrid'),
  emptyState: document.getElementById('emptyState'),
  search: document.getElementById('search'),
  filter: document.getElementById('filterCategory'),
  sort: document.getElementById('sortBy'),
  prev: document.getElementById('prevPage'),
  next: document.getElementById('nextPage'),
  pageInfo: document.getElementById('pageInfo'),
  statTotal: document.getElementById('statTotal'),
  statLow: document.getElementById('statLow'),
  statActive: document.getElementById('statActive'),
  statDisabled: document.getElementById('statDisabled'),
  exportCsv: document.getElementById('exportCsv')
};

const state = {
  page: 1,
  perPage: 10,
  totalPages: 1,
  medicines: []
};

// Format currency
const currency = (n) => `₹${Number(n).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

// Compute stats cards
function computeStats(list) {
  els.statTotal.textContent = list.length;
  els.statLow.textContent = list.filter(m => m.stock > 0 && m.stock < 10).length;
  els.statActive.textContent = list.filter(m => m.active).length;
  els.statDisabled.textContent = list.filter(m => !m.active).length;
}

// Status badges
function getStatusBadge(m) {
  if (!m.active) return '<span class="badge badge-disabled status-badge">Disabled</span>';
  if (m.stock === 0) return '<span class="badge badge-out-stock status-badge">Out of stock</span>';
  if (m.stock < 10) return '<span class="badge badge-low-stock status-badge">Low stock</span>';
  return '<span class="badge badge-in-stock status-badge">In stock</span>';
}

// Category badges
function getCategoryBadge(category){
  const map = {medicine:'Medicine', supplement:'Supplement', equipment:'Equipment', 'personal-care':'Personal Care'};
  return `<span class="badge badge-category badge-${category}">${map[category]||category}</span>`;
}

// Client-side filtering and sorting
function getFilteredSorted(list){
  let filtered = [...list];
  const q = els.search.value.trim().toLowerCase();

  if (q) {
    filtered = filtered.filter(m =>
      [m.name, m.sku, m.brand, m.category, m.description].join(' ').toLowerCase().includes(q)
    );
  }

  const cat = els.filter.value;
  if (cat !== 'all') filtered = filtered.filter(m => m.category.toLowerCase() === cat.toLowerCase());

  // Sorting
  switch(els.sort.value){
    case 'name-asc': filtered.sort((a,b)=>a.name.localeCompare(b.name)); break;
    case 'name-desc': filtered.sort((a,b)=>b.name.localeCompare(a.name)); break;
    case 'price-asc': filtered.sort((a,b)=>a.price-b.price); break;
    case 'price-desc': filtered.sort((a,b)=>b.price-a.price); break;
    case 'stock-asc': filtered.sort((a,b)=>a.stock-b.stock); break;
    case 'stock-desc': filtered.sort((a,b)=>b.stock-a.stock); break;
  }

  return filtered;
}

// Pagination
function paginate(list){
  const start = (state.page-1)*state.perPage;
  const totalPages = Math.max(1, Math.ceil(list.length/state.perPage));
  state.page = Math.min(state.page,totalPages);
  const slice = list.slice(start,start+state.perPage);
  els.pageInfo.textContent = `Page ${state.page} of ${totalPages}`;
  els.prev.disabled = state.page===1;
  els.next.disabled = state.page===totalPages;
  return slice;
}

// Render medicines grid
function renderGrid(list){
  const pageItems = paginate(list);
  computeStats(list);

  if(list.length === 0){
    els.grid.classList.add('d-none');
    els.emptyState.classList.remove('d-none');
  } else {
    els.grid.classList.remove('d-none');
    els.emptyState.classList.add('d-none');
  }

  els.grid.innerHTML = '';
  for(const m of pageItems){
    const col=document.createElement('div');
    col.className='col-xl-3 col-lg-4 col-md-6 col-sm-6 mb-4';
    col.innerHTML=`
      <div class="card medicine-card h-100">
        <div class="card-img-container position-relative">
          <img src="${m.image}" class="card-img-top" alt="${m.name}">
          <span class="sku-badge">${m.sku}</span>
          ${getStatusBadge(m)}
        </div>
        <div class="card-body d-flex flex-column">
          <div class="mb-2">${getCategoryBadge(m.category)}</div>
          <h5 class="card-title mb-2">${m.name}</h5>
          <p class="card-text text-muted small mb-3">${m.brand}</p>
          <div class="mt-auto">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="medicine-price">${currency(m.retail_price)}</span>
              <span class="text-muted small"><i class="fas fa-box me-1"></i> ${m.stock} units</span>
            </div>
            <div class="d-grid gap-2">
              <a href="/admin/medicines/${m.id}/edit" class="btn btn-sm btn-medical-primary">
                <i class="fas fa-edit me-1"></i> Edit
              </a>
            </div>
          </div>
        </div>
      </div>`;
    els.grid.appendChild(col);
  }
}

// Fetch medicines from API
async function fetchMedicines(){
  const params = new URLSearchParams();
  params.append('page', state.page);
  params.append('page_size', state.perPage);

  const searchQuery = els.search.value.trim();
  if(searchQuery) params.append('search', searchQuery);

  const category = els.filter.value;
  if(category && category !== 'all') params.append('category', category);

  switch(els.sort.value){
    case 'name-asc': params.append('ordering', 'name'); break;
    case 'name-desc': params.append('ordering', '-name'); break;
    case 'price-asc': params.append('ordering', 'retail_price'); break;
    case 'price-desc': params.append('ordering', '-retail_price'); break;

  }

  try {
    const res = await fetch(`/api/medicines/?${params.toString()}`, {
      headers: { 'Accept': 'application/json' }
    });
    const data = await res.json();
    state.medicines = data.results.map(m => ({
      id: m.id,
      name: m.name,
      sku: m.SKU,
      category: m.category?.name || 'Other',
      retail_price: m.retail_price,
      stock: m.inventory ? m.inventory.change_quantity : 0,
      active: m.is_active,
      description: m.description || '',
      brand: m.manufacturer || 'Generic',
      image: (m.medicine_images && m.medicine_images.length > 0)
        ? m.medicine_images[0]
        : '/static/images/placeholder.png'
    }));
    state.totalPages = Math.ceil(data.count / state.perPage);
    renderGrid(getFilteredSorted(state.medicines));
  } catch(err){
    console.error('Error fetching medicines:', err);
  }
}

// CSV Export
function exportCSV(){
  const headers=['SKU','Name','Brand','Category','Price (₹)','Stock','Status','Active'];
  const rows=state.medicines.map(m=>[
    m.sku,m.name,m.brand||'',m.category,m.retail_price,m.stock,
    m.stock===0?'Out of stock':m.stock<10?'Low stock':'In stock',
    m.active?'Yes':'No'
  ]);
  const csv=[headers,...rows].map(r=>r.map(c=>`"${c}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`medicines-inventory-${new Date().toISOString().split('T')[0]}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Clear filters
function clearFilters(){
  els.search.value='';
  els.filter.value='all';
  els.sort.value='name-asc';
  state.page=1;
  fetchMedicines();
}

// Event listeners
els.search.addEventListener('input',()=>{state.page=1; fetchMedicines();});
els.filter.addEventListener('change',()=>{state.page=1; fetchMedicines();});
els.sort.addEventListener('change',()=>{state.page=1; fetchMedicines();});
els.prev.addEventListener('click',()=>{state.page=Math.max(1,state.page-1); fetchMedicines();});
els.next.addEventListener('click',()=>{state.page=Math.min(state.totalPages,state.page+1); fetchMedicines();});
els.exportCsv.addEventListener('click',exportCSV);

// Initial fetch
document.addEventListener('DOMContentLoaded', () => {
  fetchMedicines();
});
</script>

{% endblock %}
