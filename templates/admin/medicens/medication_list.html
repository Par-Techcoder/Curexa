{% extends "admin/base.html" %}
{% block title %}Curexa Admin — Products{% endblock %}
{% load static %}
{% block content %}

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<style>
  .product-card {
    transition: transform 0.2s;
    height: 100%;
  }
  .product-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  .card-img-container {
    height: 180px;
    overflow: hidden;
  }
  .card-img-container img {
    object-fit: cover;
    width: 100%;
    height: 100%;
  }
  .status-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 0.75rem;
  }
  .sku-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(0,0,0,0.6);
    color: white;
    font-size: 0.7rem;
  }
  .stats-card {
    transition: transform 0.2s;
  }
  .stats-card:hover {
    transform: translateY(-3px);
  }
</style>

<div class="container-fluid py-4">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">Products Management</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal">
      <i class="bi bi-plus-circle"></i> Add Product
    </button>
  </div>

  <!-- Filters and Search -->
  <div class="row mb-4">
    <div class="col-md-4 mb-2">
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input type="text" id="search" class="form-control" placeholder="Search by name, SKU or brand...">
      </div>
    </div>
    <div class="col-md-3 mb-2">
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-filter"></i></span>
        <select id="filterCategory" class="form-select">
          <option value="all">All categories</option>
          <option value="medicine">Medicine</option>
          <option value="supplement">Supplements</option>
          <option value="equipment">Equipment</option>
          <option value="personal-care">Personal Care</option>
        </select>
      </div>
    </div>
    <div class="col-md-3 mb-2">
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-sort-down"></i></span>
        <select id="sortBy" class="form-select">
          <option value="name-asc">Name (A→Z)</option>
          <option value="name-desc">Name (Z→A)</option>
          <option value="price-asc">Price (Low→High)</option>
          <option value="price-desc">Price (High→Low)</option>
          <option value="stock-desc">Stock (High→Low)</option>
        </select>
      </div>
    </div>
    <div class="col-md-2 mb-2 d-flex">
      <button id="exportCsv" class="btn btn-outline-secondary me-2 flex-fill">
        <i class="bi bi-download"></i> Export
      </button>
      <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
          <i class="bi bi-three-dots"></i>
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#">Bulk Edit</a></li>
          <li><a class="dropdown-item" href="#">Export JSON</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="#">Delete Selected</a></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card stats-card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <h5 class="card-title text-muted fs-6">Total Products</h5>
            <i class="bi bi-boxes text-primary"></i>
          </div>
          <h2 id="statTotal" class="card-text fw-bold">0</h2>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card stats-card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <h5 class="card-title text-muted fs-6">Low Stock (&lt; 10)</h5>
            <i class="bi bi-exclamation-triangle text-warning"></i>
          </div>
          <h2 id="statLow" class="card-text fw-bold">0</h2>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card stats-card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <h5 class="card-title text-muted fs-6">Active</h5>
            <i class="bi bi-check-circle text-success"></i>
          </div>
          <h2 id="statActive" class="card-text fw-bold">0</h2>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card stats-card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <h5 class="card-title text-muted fs-6">Disabled</h5>
            <i class="bi bi-x-circle text-danger"></i>
          </div>
          <h2 id="statDisabled" class="card-text fw-bold">0</h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Grid -->
  <div class="row" id="productGrid"></div>

  <!-- Pagination -->
  <div class="d-flex justify-content-between align-items-center mt-4">
    <div id="pageInfo" class="text-muted">Page 1</div>
    <div>
      <button id="prevPage" class="btn btn-outline-primary btn-sm me-2">Previous</button>
      <button id="nextPage" class="btn btn-outline-primary btn-sm">Next</button>
    </div>
  </div>
</div>

<!-- Add/Edit Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Add Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="productForm">
        <div class="modal-body">
          <input type="hidden" id="productId">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="name" class="form-label">Name</label>
              <input type="text" class="form-control" id="name" placeholder="Paracetamol 650mg" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="sku" class="form-label">SKU</label>
              <input type="text" class="form-control" id="sku" placeholder="MED-0001" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="category" class="form-label">Category</label>
              <select class="form-select" id="category">
                <option value="medicine">Medicine</option>
                <option value="supplement">Supplement</option>
                <option value="equipment">Equipment</option>
                <option value="personal-care">Personal Care</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="price" class="form-label">Price (₹)</label>
              <input type="number" step="0.01" min="0" class="form-control" id="price" placeholder="99.00" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="stock" class="form-label">Stock</label>
              <input type="number" min="0" class="form-control" id="stock" placeholder="150" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="image" class="form-label">Image URL</label>
              <input type="url" class="form-control" id="image" placeholder="https://images.example.com/product.jpg">
            </div>
            <div class="col-12 mb-3">
              <label for="description" class="form-label">Description</label>
              <textarea class="form-control" id="description" rows="3" placeholder="Brief details for your product."></textarea>
            </div>
            <div class="col-12">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="active" checked>
                <label class="form-check-label" for="active">Active</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Product</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const state = {
    page: 1,
    perPage: 8,
    products: [
      { id: crypto.randomUUID(), name: 'Paracetamol 650mg', sku: 'MED-0001', category: 'medicine', price: 29.0, stock: 120, active: true, image: 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?q=80&w=1200&auto=format&fit=crop', description: 'Analgesic and antipyretic.' },
      { id: crypto.randomUUID(), name: 'Digital Thermometer', sku: 'EQP-0043', category: 'equipment', price: 299.0, stock: 8, active: true, image: 'https://images.unsplash.com/photo-1582719508461-905c673771fd?q=80&w=1200&auto=format&fit=crop', description: 'Fast and accurate readings.' },
      { id: crypto.randomUUID(), name: 'Vitamin C 1000mg', sku: 'SUP-0102', category: 'supplement', price: 249.0, stock: 64, active: true, image: 'https://images.unsplash.com/photo-1616410011236-7db1d1b4b2c2?q=80&w=1200&auto=format&fit=crop', description: 'Immune support tablets.' },
      { id: crypto.randomUUID(), name: 'Hand Sanitizer 500ml', sku: 'PC-0200', category: 'personal-care', price: 149.0, stock: 0, active: false, image: 'https://images.unsplash.com/photo-1584630176563-073cc05f9030?q=80&w=1200&auto=format&fit=crop', description: 'Kills 99.9% germs.' },
      { id: crypto.randomUUID(), name: 'Blood Pressure Monitor', sku: 'EQP-1001', category: 'equipment', price: 1899.0, stock: 23, active: true, image: 'https://images.unsplash.com/photo-1576765608731-47e02b3b2c7a?q=80&w=1200&auto=format&fit=crop', description: 'Automatic BP monitor.' },
      { id: crypto.randomUUID(), name: 'Zinc Tablets 50mg', sku: 'SUP-0330', category: 'supplement', price: 199.0, stock: 15, active: true, image: 'https://images.unsplash.com/photo-1607619056574-7b8d3ee536b2?q=80&w=1200&auto=format&fit=crop', description: 'Dietary supplement.' },
      { id: crypto.randomUUID(), name: 'Cough Syrup 100ml', sku: 'MED-0209', category: 'medicine', price: 110.0, stock: 7, active: true, image: 'https://images.unsplash.com/photo-1597074866922-020f77a7a062?q=80&w=1200&auto=format&fit=crop', description: 'Soothing relief.' },
      { id: crypto.randomUUID(), name: 'Infrared Thermometer', sku: 'EQP-0044', category: 'equipment', price: 1499.0, stock: 3, active: false, image: 'https://images.unsplash.com/photo-1581089781785-603411fa81e5?q=80&w=1200&auto=format&fit=crop', description: 'Contactless temperature.' },
      { id: crypto.randomUUID(), name: 'Multivitamin Capsules', sku: 'SUP-0103', category: 'supplement', price: 399.0, stock: 75, active: true, image: 'https://images.unsplash.com/photo-1582719478250-71b68c7cb1bf?q=80&w=1200&auto=format&fit=crop', description: 'Daily multivitamin.' },
      { id: crypto.randomUUID(), name: 'Antiseptic Liquid 1L', sku: 'PC-0201', category: 'personal-care', price: 220.0, stock: 11, active: true, image: 'https://images.unsplash.com/photo-1604152135912-04a022e23696?q=80&w=1200&auto=format&fit=crop', description: 'For first aid & hygiene.' }
    ]
  };

  const els = {
    grid: document.getElementById('productGrid'),
    search: document.getElementById('search'),
    filter: document.getElementById('filterCategory'),
    sort: document.getElementById('sortBy'),
    modal: document.getElementById('productModal'),
    form: document.getElementById('productForm'),
    productId: document.getElementById('productId'),
    name: document.getElementById('name'),
    sku: document.getElementById('sku'),
    category: document.getElementById('category'),
    price: document.getElementById('price'),
    stock: document.getElementById('stock'),
    image: document.getElementById('image'),
    description: document.getElementById('description'),
    active: document.getElementById('active'),
    modalTitle: document.getElementById('modalTitle'),
    prev: document.getElementById('prevPage'),
    next: document.getElementById('nextPage'),
    pageInfo: document.getElementById('pageInfo'),
    statTotal: document.getElementById('statTotal'),
    statLow: document.getElementById('statLow'),
    statActive: document.getElementById('statActive'),
    statDisabled: document.getElementById('statDisabled'),
    exportCsv: document.getElementById('exportCsv')
  };

  // Helpers
  const currency = (n) => `₹${Number(n).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
  const byQuery = (q) => (p) => [p.name, p.sku, p.category].join(' ').toLowerCase().includes(q);

  function computeStats(list) {
    els.statTotal.textContent = list.length;
    els.statLow.textContent = list.filter(p => p.stock < 10).length;
    els.statActive.textContent = list.filter(p => p.active).length;
    els.statDisabled.textContent = list.filter(p => !p.active).length;
  }

  function getFilteredSorted() {
    let list = [...state.products];
    const q = els.search.value.trim().toLowerCase();
    if (q) list = list.filter(byQuery(q));
    const cat = els.filter.value;
    if (cat !== 'all') list = list.filter(p => p.category === cat);
    switch (els.sort.value) {
      case 'name-asc': list.sort((a,b)=>a.name.localeCompare(b.name)); break;
      case 'name-desc': list.sort((a,b)=>b.name.localeCompare(a.name)); break;
      case 'price-asc': list.sort((a,b)=>a.price-b.price); break;
      case 'price-desc': list.sort((a,b)=>b.price-a.price); break;
      case 'stock-desc': list.sort((a,b)=>b.stock-a.stock); break;
    }
    return list;
  }

  function paginate(list) {
    const start = (state.page - 1) * state.perPage;
    const end = start + state.perPage;
    const totalPages = Math.max(1, Math.ceil(list.length / state.perPage));
    state.page = Math.min(state.page, totalPages);
    const slice = list.slice(start, end);
    els.pageInfo.textContent = `Page ${state.page} of ${totalPages}`;
    els.prev.disabled = state.page === 1;
    els.next.disabled = state.page === totalPages;
    return slice;
  }

  function getStatusBadge(product) {
    if (product.stock === 0) {
      return '<span class="badge bg-danger status-badge">Out of stock</span>';
    } else if (product.stock < 10) {
      return '<span class="badge bg-warning status-badge">Low stock</span>';
    } else {
      return '<span class="badge bg-success status-badge">In stock</span>';
    }
  }

  function render() {
    const list = getFilteredSorted();
    computeStats(list);
    const pageItems = paginate(list);
    els.grid.innerHTML = '';

    for (const p of pageItems) {
      const col = document.createElement('div');
      col.className = 'col-md-3 col-sm-6 mb-4';
      col.innerHTML = `
        <div class="card product-card h-100">
          <div class="card-img-container position-relative">
            <img src="${p.image || 'https://images.unsplash.com/photo-1582719478250-71b68c7cb1bf?q=80&w=1200&auto=format&fit=crop'}" class="card-img-top" alt="${p.name}">
            <span class="badge sku-badge">${p.sku}</span>
            ${getStatusBadge(p)}
          </div>
          <div class="card-body">
            <h5 class="card-title">${p.name}</h5>
            <p class="card-text text-muted text-capitalize">${p.category.replace('-', ' ')}</p>
            <p class="card-text fw-bold">${currency(p.price)}</p>
          </div>
          <div class="card-footer bg-transparent">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <button class="btn btn-sm btn-outline-primary me-1 edit-btn" data-id="${p.id}">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary me-1 duplicate-btn" data-id="${p.id}">
                  <i class="bi bi-copy"></i>
                </button>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input toggle-active" type="checkbox" data-id="${p.id}" ${p.active ? 'checked' : ''}>
              </div>
              <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${p.id}">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        </div>
      `;
      
      // Add event listeners
      col.querySelector('.edit-btn').addEventListener('click', () => openModal(p));
      col.querySelector('.duplicate-btn').addEventListener('click', () => duplicateProduct(p.id));
      col.querySelector('.delete-btn').addEventListener('click', () => deleteProduct(p.id));
      col.querySelector('.toggle-active').addEventListener('change', (e) => toggleActive(p.id, e.target.checked));
      
      els.grid.appendChild(col);
    }
    
    // Enable/disable pagination buttons
    els.prev.disabled = state.page === 1;
    els.next.disabled = state.page === Math.ceil(list.length / state.perPage);
  }

  function openModal(product = null) {
    const modal = new bootstrap.Modal(document.getElementById('productModal'));
    els.form.reset();
    els.productId.value = product?.id || '';
    document.getElementById('modalTitle').textContent = product ? 'Edit Product' : 'Add Product';
    
    if (product) {
      els.name.value = product.name;
      els.sku.value = product.sku;
      els.category.value = product.category;
      els.price.value = product.price;
      els.stock.value = product.stock;
      els.image.value = product.image || '';
      els.description.value = product.description || '';
      els.active.checked = product.active;
    } else {
      els.active.checked = true;
    }
    
    modal.show();
  }

  function closeModal() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
    modal.hide();
  }

  function saveProduct(e) {
    e.preventDefault();
    const data = {
      id: els.productId.value || crypto.randomUUID(),
      name: els.name.value.trim(),
      sku: els.sku.value.trim(),
      category: els.category.value,
      price: parseFloat(els.price.value),
      stock: parseInt(els.stock.value, 10),
      image: els.image.value.trim(),
      description: els.description.value.trim(),
      active: els.active.checked
    };
    const exists = state.products.find(p => p.id === data.id);
    if (exists) Object.assign(exists, data); else state.products.unshift(data);
    closeModal();
    render();
  }

  function deleteProduct(id) {
    if (!confirm('Are you sure you want to delete this product?')) return;
    state.products = state.products.filter(p => p.id !== id);
    render();
  }

  function duplicateProduct(id) {
    const p = state.products.find(x => x.id === id);
    if (!p) return;
    const copy = { ...p, id: crypto.randomUUID(), sku: p.sku + '-COPY', name: p.name + ' (Copy)' };
    state.products.unshift(copy);
    render();
  }

  function toggleActive(id, value) {
    const p = state.products.find(x => x.id === id);
    if (!p) return;
    p.active = value;
    render();
  }

  function exportCSV() {
    const headers = ['ID','Name','SKU','Category','Price','Stock','Active'];
    const rows = state.products.map(p => [p.id, p.name, p.sku, p.category, p.price, p.stock, p.active]);
    const csv = [headers, ...rows].map(r => r.map(v => typeof v === 'string' && v.includes(',') ? `"${v}"` : v).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'products.csv'; a.click();
    URL.revokeObjectURL(url);
  }

  // Event listeners
  els.search.addEventListener('input', () => { state.page = 1; render(); });
  els.filter.addEventListener('change', () => { state.page = 1; render(); });
  els.sort.addEventListener('change', () => { state.page = 1; render(); });
  els.prev.addEventListener('click', () => { state.page = Math.max(1, state.page - 1); render(); });
  els.next.addEventListener('click', () => { state.page = state.page + 1; render(); });
  els.form.addEventListener('submit', saveProduct);
  els.exportCsv.addEventListener('click', exportCSV);

  // Initialize
  render();
</script>

{% endblock %}